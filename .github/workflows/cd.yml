name: CD - Continuous Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download latest model artifacts
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: train.yml
        name: model-artifacts
        path: models/
        if_no_artifact_found: warn
      continue-on-error: true
    
    - name: Verify model exists
      run: |
        if [ -f "models/best_random_forest_model.pkl" ]; then
          echo "âœ… Model found and ready for deployment"
          ls -lh models/
        else
          echo "âš ï¸ No model found. Train locally first with: python src/train.py"
          exit 0
        fi
    
    - name: Run tests before deployment
      run: |
        pytest tests/ -v
    
    - name: Build deployment package
      run: |
        mkdir -p deployment
        cp -r src/ deployment/
        cp -r models/ deployment/
        cp -r config/ deployment/ || cp params.yaml deployment/
        cp requirements.txt deployment/
        echo "âœ… Deployment package created"
    
    - name: Package model artifacts
      run: |
        tar -czf model-deployment.tar.gz deployment/
        echo "âœ… Model packaged for deployment"
    
    - name: Upload deployment package
      uses: actions/upload-artifact@v3
      with:
        name: deployment-package
        path: model-deployment.tar.gz
    
    - name: Create deployment manifest
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Package Contents" >> $GITHUB_STEP_SUMMARY
        echo "- Source code (src/)" >> $GITHUB_STEP_SUMMARY
        echo "- Trained model (models/)" >> $GITHUB_STEP_SUMMARY
        echo "- Configuration files" >> $GITHUB_STEP_SUMMARY
        echo "- Dependencies (requirements.txt)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Model Metrics" >> $GITHUB_STEP_SUMMARY
        if [ -f "models/metrics.txt" ]; then
          cat models/metrics.txt >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the deployment package artifact" >> $GITHUB_STEP_SUMMARY
        echo "2. Extract: tar -xzf model-deployment.tar.gz" >> $GITHUB_STEP_SUMMARY
        echo "3. Deploy locally or to your server" >> $GITHUB_STEP_SUMMARY
    
    - name: Deployment status
      run: |
        echo "âœ… CD Pipeline Complete!"
        echo "ðŸ“¦ Deployment package ready for download from Actions artifacts"
